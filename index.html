<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>流芳·书赠玉笙</title>
    <style>
        /* --- 全局设置 --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            font-family: "KaiTi", "STKaiti", "楷体", serif;
            user-select: none; /* 禁止选中 */
            /* 禁止iOS点击高亮 */
            -webkit-tap-highlight-color: transparent;
        }

        /* --- 鎏金字效 --- */
        .gilded-text {
            background: linear-gradient(to right, #e6c885 10%, #ffeb3b 40%, #d4af37 60%, #e6c885 90%);
            -webkit-background-clip: text; background-clip: text; color: transparent;
            filter: drop-shadow(1px 1px 0px rgba(0, 0, 0, 0.5)); 
            font-weight: bold;
        }

        /* ================= 第一页：婚书 (完整显示版) ================= */
        #page1 {
            position: absolute; width: 100%; height: 100%;
            
            /* 背景图完整显示设置 */
            background-color: #000; 
            background-image: url('婚书背景图.jpg'); 
            background-size: contain; /* 确保图片完整，可能有黑边 */
            background-repeat: no-repeat;
            background-position: center; 
            
            z-index: 10;
            
            /* Flex 居中布局 */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            
            transition: opacity 2s ease-in-out;
            cursor: pointer;
        }

        /* 边框：【修改】全部使用 vmin，确保随宽度缩放 */
        .border-frame {
            position: absolute; 
            /* 距离边缘的距离也随屏幕宽度缩放 */
            top: 4vmin; bottom: 4vmin; left: 4vmin; right: 4vmin;
            /* 边框粗细 */
            border: 0.5vmin solid #d4af37; 
            /* 圆角大小 */
            border-radius: 3vmin; 
            pointer-events: none; opacity: 0.6;
        }
        /* 内层细边框 */
        .border-frame::after {
            content: ""; position: absolute; 
            top: 1.5vmin; bottom: 1.5vmin; left: 1.5vmin; right: 1.5vmin;
            border: 0.2vmin solid #d4af37; 
            border-radius: 1.5vmin;
        }

        /* 标题区 */
        #title { 
            font-size: 10vmin; 
            /* 距离顶部的位置，使用 vh 稍微兼顾高度 */
            margin-top: 10vh; 
            margin-bottom: 2vh; 
            letter-spacing: 2vmin; 
        }
        
        /* 正文区 */
        #text-container {
            width: 85vw; 
            height: 55vh; 
            
            writing-mode: vertical-rl; 
            font-size: 3.5vmin; 
            line-height: 6vmin; 
            letter-spacing: 0.8vmin; 
            
            text-align: left; 
            display: flex; 
            flex-wrap: wrap; 
            align-content: center; 
            justify-content: center;
        }

        .line { opacity: 0; transition: opacity 1.5s ease; margin-left: 1.5vmin; }

        /* 签名区：【修改】核心优化，智能缩放 */
        #sign-section {
            width: 90%; 
            position: absolute; 
            /* 使用 vmin 控制底部距离，避免在超长屏上掉得太低 */
            bottom: 12vmin; 
            padding-bottom: env(safe-area-inset-bottom);
            display: none; 
            flex-direction: column; 
            align-items: center; 
            z-index: 20;
        }
        .sign-box-container { 
            display: flex; 
            justify-content: space-between; 
            width: 100%; 
            /* 限制最大宽度，保持手机观感 */
            padding: 0 4vmin; 
            box-sizing: border-box; 
        }
        .sign-box { 
            width: 42%; /* 左右各占 42% */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        
        .canvas-wrap {
            width: 100%; 
            /* 签字区高度加大，随宽度缩放 */
            height: 16vmin; 
            background-color: transparent; 
            /* 下划线粗细 */
            border-bottom: 0.5vmin solid #d4af37; 
        }
        canvas { width: 100%; height: 100%; cursor: crosshair; }
        
        /* 标签文字大小优化 */
        .sign-label { 
            margin-top: 2vmin; 
            font-size: 3.5vmin; /* 字号加大，更清晰 */
            opacity: 0.9; 
            letter-spacing: 0.5vmin;
        }

        /* ================= 第二页：粒子爱心 ================= */
        #page2 {
            position: absolute; width: 100%; height: 100%;
            background: #000; display: none; z-index: 5; overflow: hidden;
        }

        #heart-canvas {
            position: absolute; left: 0; top: 0; width: 100%; height: 100%;
            z-index: 1; 
        }

        #words-container { 
            position: absolute; width: 100%; height: 100%; top: 0; left: 0; 
            z-index: 10; pointer-events: none; 
        }
        
        .floating-word {
            position: absolute; color: #fff; 
            font-size: 3vmin; 
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
            white-space: nowrap; 
            animation: textPop 1.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; 
            opacity: 0;
            font-family: "KaiTi";
        }
        
        .semi-transparent { opacity: 0.1 !important; text-shadow: none; }
        
        @keyframes textPop { 
            0% { opacity: 0; transform: scale(0); } 
            60% { opacity: 1; transform: scale(1.1); } 
            100% { opacity: 1; transform: scale(1); } 
        }

        /* ================= 第三页：求签 (智能缩放版) ================= */
        #page3 {
            position: absolute; width: 100%; height: 100%;
            background-color: #f5f5f0; 
            display: none; z-index: 6;
            flex-direction: column; align-items: center; justify-content: center;
        }

        /* 签筒容器 */
        #lot-container {
            position: relative; 
            width: 30vmin;  
            height: 56vmin; 
            margin-top: 5vmin; 
            cursor: pointer;
        }

        .cylinder-body {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 75%; 
            background: linear-gradient(90deg, #5c4033 0%, #8b5a2b 40%, #5c4033 100%);
            border-radius: 2vmin 2vmin 6vmin 6vmin;
            box-shadow: 0 2vmin 4vmin rgba(0,0,0,0.3);
            z-index: 10;
            display: flex; align-items: center; justify-content: center;
        }
        
        .cylinder-text {
            writing-mode: vertical-rl; 
            font-size: 8vmin; 
            color: #3e2723;
            font-family: "KaiTi"; opacity: 0.7; 
            letter-spacing: 2vmin;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.2);
            border: 0.4vmin solid #3e2723; 
            padding: 2vmin 1vmin;
        }

        #stick {
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%);
            width: 28%; 
            height: 85%; 
            background: linear-gradient(90deg, #e0c38c 0%, #f5deb3 50%, #e0c38c 100%);
            background-image: repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,0.05) 2px, rgba(0,0,0,0.05) 3px);
            border: 1px solid #d2b48c; border-radius: 1vmin 1vmin 0 0;
            z-index: 5; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0.5vmin 0.5vmin 1vmin rgba(0,0,0,0.1);
            transition: transform 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #stick-text {
            writing-mode: vertical-rl; 
            display: flex; flex-direction: column; flex-wrap: wrap; 
            align-items: center; justify-content: center; 
            gap: 1vmin; 
            font-size: 2.2vmin; 
            font-weight: bold; 
            letter-spacing: 0.5vmin; 
            opacity: 0; transition: opacity 0.5s;
            height: 90%; width: 100%; 
            color: #2b1b17; font-family: "KaiTi";
        }
        
        .poem-line { display: block; white-space: nowrap; }
        .shake-anim { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
        .stick-rise { transform: translateX(-50%) translateY(-60%) !important; } 

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
    </style>
</head>
<body>

    <div id="page1" onclick="startAutoReveal()">
        <div class="border-frame"></div>
        <div id="title" class="gilded-text" style="writing-mode: horizontal-tb;">婚 书</div>

        <div id="text-container">
            <p id="line1" class="line gilded-text">两姓联姻，一堂缔约</p>
            <p id="line2" class="line gilded-text">良缘永结，匹配同称</p>
            <p id="line3" class="line gilded-text">看此日桃花灼灼</p>
            <p id="line4" class="line gilded-text">宜室宜家</p>
            <p id="line5" class="line gilded-text">卜他年瓜瓞绵绵</p>
            <p id="line6" class="line gilded-text">尔昌尔炽</p>
            <p id="line7" class="line gilded-text">谨以白头之约</p>
            <p id="line8" class="line gilded-text">书向鸿笺</p>
            <p id="line9" class="line gilded-text">好将红叶之盟</p>
            <p id="line10" class="line gilded-text">载明鸳谱</p>
        </div>

        <div id="sign-section">
            <div class="sign-box-container">
                <div class="sign-box">
                    <div class="canvas-wrap"><canvas id="canvasFang"></canvas></div>
                    <div class="sign-label gilded-text">新郎 落款</div>
                </div>
                <div class="sign-box">
                    <div class="canvas-wrap"><canvas id="canvasYang"></canvas></div>
                    <div class="sign-label gilded-text">新娘 落款</div>
                </div>
            </div>
        </div>
    </div>

    <div id="page2">
        <canvas id="heart-canvas"></canvas>
        <div id="words-container"></div>
    </div>

    <div id="page3">
        <div id="lot-container" onclick="drawLot()">
            <div id="stick"><span id="stick-text"></span></div>
            <div class="cylinder-body">
                <div class="cylinder-text">求签</div>
            </div>
        </div>
    </div>

    <script>
        /* ================= 【配置区域】 ================= */
        const FIRST_FORTUNE = "所愿皆所成"; 
        const RANDOM_FORTUNES = [
            "前程似锦", 
            "万事胜意", 
            "志得意满", 
            "意气风发",
            "愿君千万岁，无岁不逢春", 
            "天保定尔，俾尔戬穀。罄无不宜，受天百禄",
            "彩笔题桐叶，佳句问平安",
            "知君志不小，一举凌鸿鹄",
            "愿我如星君如月，夜夜流光相皎洁",
            "一鸣从此始，相望青云端"
        ];

        /* ============================================================= */

        // --- 1. 婚书逻辑 ---
        let currentLine = 1;
        const totalLines = 10;
        let revealState = 0; 
        let revealInterval;

        function startAutoReveal() {
            if (revealState === 2) return;
            if (revealState === 0) {
                revealState = 1;
                revealInterval = setInterval(() => {
                    if (currentLine <= totalLines) {
                        document.getElementById('line' + currentLine).style.opacity = 1;
                        currentLine++;
                    } else {
                        finishReveal();
                    }
                }, 800); 
            } else if (revealState === 1) {
                clearInterval(revealInterval);
                for (let i = 1; i <= totalLines; i++) {
                    document.getElementById('line' + i).style.opacity = 1;
                }
                currentLine = totalLines + 1;
                finishReveal();
            }
        }

        function finishReveal() {
            revealState = 2;
            clearInterval(revealInterval);
            setTimeout(() => {
                document.getElementById('sign-section').style.display = 'flex';
                initCanvas('canvasFang', 'fang');
                initCanvas('canvasYang', 'yang');
                document.getElementById('page1').onclick = null;
            }, 500);
        }

        // --- 2. 签名逻辑 (硬核防误触 + 移动端适配) ---
        let fangSigned = false;
        let yangSigned = false;
        let signOrder = []; 

        function initCanvas(canvasId, userType) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            canvas.style.width = rect.width + "px";
            canvas.style.height = rect.height + "px";

            ctx.lineWidth = 3; 
            ctx.strokeStyle = "#d4af37"; 
            ctx.lineCap = "round"; 
            ctx.lineJoin = "round";

            let isDrawing = false; 
            let strokePoints = 0; 

            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                let clientX = e.touches ? e.touches[0].clientX : e.clientX;
                let clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            }

            const start = (e) => {
                isDrawing = true; 
                strokePoints = 0; 
                const pos = getPos(e);
                ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
                if(e.type !== 'mousedown') ; 
            };

            const move = (e) => {
                if (!isDrawing) return; 
                strokePoints++; 
                const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke();
                if(e.cancelable) e.preventDefault(); 
            };

            const end = () => {
                // 滑动超过 20 个单位才算签字
                if (isDrawing && strokePoints > 20) {
                    if (userType === 'fang') fangSigned = true;
                    if (userType === 'yang') yangSigned = true;
                    if (!signOrder.includes(userType)) signOrder.push(userType);
                    checkFinish();
                }
                isDrawing = false;
            };

            canvas.addEventListener('touchstart', start, {passive: false});
            canvas.addEventListener('touchmove', move, {passive: false});
            canvas.addEventListener('touchend', end);
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', move);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('mouseleave', end);
        }

        // --- 3. 结局分支判定 (5秒延时) ---
        function checkFinish() {
            if (fangSigned && yangSigned) {
                setTimeout(() => {
                    const p1 = document.getElementById('page1');
                    p1.style.opacity = 0; 
                    setTimeout(() => {
                        p1.style.display = 'none';
                        if (signOrder[0] === 'yang') {
                            const p3 = document.getElementById('page3');
                            p3.style.display = 'flex'; 
                        } else {
                            const p2 = document.getElementById('page2');
                            p2.style.display = 'block';
                            initParticleHeart(); 
                            startRomanticExplosion(); 
                        }
                    }, 2000); 
                }, 5000); 
            }
        }

        // --- 4. 求签逻辑 (智能字号版) ---
        let hasDrawn = false; 
        let isAnimating = false;

        function drawLot() {
            if (isAnimating) return; 
            isAnimating = true;

            const container = document.getElementById('lot-container');
            const stick = document.getElementById('stick');
            const textEl = document.getElementById('stick-text');

            stick.classList.remove('stick-rise');
            textEl.style.opacity = 0;
            textEl.innerHTML = ""; 
            
            container.classList.add('shake-anim');

            setTimeout(() => {
                container.classList.remove('shake-anim');
                let resultText = !hasDrawn ? FIRST_FORTUNE : RANDOM_FORTUNES[Math.floor(Math.random() * RANDOM_FORTUNES.length)];
                if (!hasDrawn) hasDrawn = true;
                
                if (resultText.includes("，") || resultText.includes(",")) {
                    const parts = resultText.split(/，|,/); 
                    if (parts.length >= 2) {
                        const baseSize = window.innerWidth < 500 ? 2.0 : 2.2; 
                        textEl.style.fontSize = baseSize + "vmin"; 
                        textEl.innerHTML = `<span class="poem-line">${parts[0]}</span><span class="poem-line">${parts[1]}</span>`;
                    } else {
                        textEl.style.fontSize = "2.8vmin";
                        textEl.innerText = resultText;
                    }
                } else {
                    textEl.style.fontSize = "3.0vmin";
                    textEl.innerText = resultText;
                }

                stick.classList.add('stick-rise');
                
                setTimeout(() => {
                    textEl.style.opacity = 1;
                    isAnimating = false; 
                }, 500);
            }, 1000); 
        }

        // --- 5. 粒子爱心引擎 (高清适配版) ---
        function initParticleHeart() {
            var canvas = document.getElementById('heart-canvas');
            var ctx = canvas.getContext('2d');
            
            var dpr = window.devicePixelRatio || 1;
            var width, height;
            
            var resize = function() {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width * dpr;
                canvas.height = height * dpr;
                canvas.style.width = width + "px";
                canvas.style.height = height + "px";
                ctx.scale(dpr, dpr);
            }
            resize();
            window.addEventListener('resize', resize);
            
            var rand = Math.random;
            var heartPosition = function (rad) {
                return [Math.pow(Math.sin(rad), 3), -(15 * Math.cos(rad) - 5 * Math.cos(2 * rad) - 2 * Math.cos(3 * rad) - Math.cos(4 * rad))];
            };
            var scaleAndTranslate = function (pos, sx, sy, dx, dy) {
                return [dx + pos[0] * sx, dy + pos[1] * sy];
            };

            var mobile = width < 600;
            var traceCount = mobile ? 20 : 50;
            var pointsOrigin = [];
            var i;
            var dr = mobile ? 0.3 : 0.1;
            
            var heartScale = Math.min(width, height) / 800; 
            var sx = 210 * heartScale; 
            var sy = 13 * heartScale;

            for (i = 0; i < Math.PI * 2; i += dr) pointsOrigin.push(scaleAndTranslate(heartPosition(i), sx, sy, 0, 0));
            for (i = 0; i < Math.PI * 2; i += dr) pointsOrigin.push(scaleAndTranslate(heartPosition(i), 150*heartScale, 9*heartScale, 0, 0));
            for (i = 0; i < Math.PI * 2; i += dr) pointsOrigin.push(scaleAndTranslate(heartPosition(i), 90*heartScale, 5*heartScale, 0, 0));
            
            var heartPointsCount = pointsOrigin.length;
            var targetPoints = [];
            
            var pulse = function (kx, ky) {
                for (i = 0; i < pointsOrigin.length; i++) {
                    targetPoints[i] = [];
                    targetPoints[i][0] = kx * pointsOrigin[i][0] + width / 2;
                    targetPoints[i][1] = ky * pointsOrigin[i][1] + height / 2;
                }
            };

            var e = [];
            for (i = 0; i < heartPointsCount; i++) {
                var x = rand() * width;
                var y = rand() * height;
                e[i] = {
                    vx: 0, vy: 0, R: 2, speed: rand() + 5,
                    q: ~~(rand() * heartPointsCount),
                    D: 2 * (i % 2) - 1,
                    force: 0.2 * rand() + 0.7,
                    f: "hsla(0," + ~~(40 * rand() + 60) + "%," + ~~(60 * rand() + 20) + "%,.3)",
                    trace: []
                };
                for (var k = 0; k < traceCount; k++) e[i].trace[k] = {x: x, y: y};
            }

            var config = { traceK: 0.4, timeDelta: 0.01 };
            var time = 0;

            var loop = function () {
                var n = -Math.cos(time);
                pulse((1 + n) * .5, (1 + n) * .5);
                time += ((Math.sin(time)) < 0 ? 9 : (n > 0.8) ? .2 : 1) * config.timeDelta;
                
                ctx.fillStyle = "rgba(0,0,0,.1)"; 
                ctx.fillRect(0, 0, width, height);
                
                for (i = e.length; i--;) {
                    var u = e[i];
                    var q = targetPoints[u.q];
                    var dx = u.trace[0].x - q[0];
                    var dy = u.trace[0].y - q[1];
                    var length = Math.sqrt(dx * dx + dy * dy);
                    
                    if (10 > length) {
                        if (0.95 < rand()) {
                            u.q = ~~(rand() * heartPointsCount);
                        } else {
                            if (0.99 < rand()) { u.D *= -1; }
                            u.q += u.D;
                            u.q %= heartPointsCount;
                            if (0 > u.q) { u.q += heartPointsCount; }
                        }
                    }
                    u.vx += -dx / length * u.speed;
                    u.vy += -dy / length * u.speed;
                    u.trace[0].x += u.vx;
                    u.trace[0].y += u.vy;
                    u.vx *= u.force;
                    u.vy *= u.force;
                    
                    for (k = 0; k < u.trace.length - 1;) {
                        var T = u.trace[k];
                        var N = u.trace[++k];
                        N.x -= config.traceK * (N.x - T.x);
                        N.y -= config.traceK * (N.y - T.y);
                    }
                    ctx.fillStyle = u.f;
                    for (k = 0; k < u.trace.length; k++) {
                        ctx.fillRect(u.trace[k].x, u.trace[k].y, 1, 1);
                    }
                }
                requestAnimationFrame(loop);
            };
            loop();
        }

        // --- 6. 情话弹幕逻辑 ---
        const loveWords = [ "所愿皆所成" ];
        
        function startRomanticExplosion() {
            const container = document.getElementById('words-container');
            let count = 0;
            const maxWords = 150; 

            const interval = setInterval(() => {
                if (count >= maxWords) {
                    clearInterval(interval);
                    return;
                }

                const wordEl = document.createElement('span');
                wordEl.classList.add('floating-word');
                wordEl.innerText = loveWords[0]; 

                const randomTop = Math.random() * 95;
                const randomLeft = Math.random() * 90;

                // 防遮挡检测 (中间区域透明)
                if (randomTop > 25 && randomTop < 75 && randomLeft > 20 && randomLeft < 80) {
                    wordEl.classList.add('semi-transparent');
                }

                wordEl.style.top = randomTop + '%';
                wordEl.style.left = randomLeft + '%';
                // 字体大小也使用动态计算
                wordEl.style.fontSize = (Math.random() * 2 + 1.5) + 'vmin';
                
                container.appendChild(wordEl);
                count++;

            }, 200); 
        }
    </script>
</body>
</html>
